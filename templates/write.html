{% extends "base.html" %}

{% block title %}{{ category }}ì— ìƒˆ ê¸€ ì‘ì„±{% endblock %}

{% block body_class %}{{ 'photo-background' if is_gallery_category else '' }}{% endblock %}

{% block head_scripts %}
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>
{% endblock %}

{% block content %}
  <div class="qa-write">
    <h2>ğŸ“Œ {{ category }}ì— ìƒˆ ê¸€ ì‘ì„±</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul>
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form method="POST"
          action="{{ url_for('post.write') }}?category={{ category }}"
          enctype="multipart/form-data">

      {{ form.csrf_token if form and form.csrf_token }}

      <label for="title">ì œëª©</label>
      <input type="text" name="title" id="title" required>

      <label for="author">ì‘ì„±ì</label>
      <input type="text" name="author" id="author" required>

      <label for="content">ë‚´ìš©</label>
      <textarea name="content" id="editor"></textarea>

      <label for="image">ì´ë¯¸ì§€ ì²¨ë¶€</label>
      <input type="file" name="image" accept="image/*">

      <button type="submit" class="btn">ë“±ë¡í•˜ê¸°</button>
    </form>

    <div class="action-back">
      <a href="{{ url_for('post.index', category=category, page=1) }}">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    let editorInstance;

    ClassicEditor
      .create(document.querySelector('#editor'), {
        ckfinder: {
          uploadUrl: "{{ url_for('post.upload_image') }}"
        }
      })
      .then(editor => {
        editorInstance = editor;

        const viewDocument = editor.editing.view.document;
        viewDocument.on('change:isFocused', () => {
          for (const viewElement of viewDocument.getRoot().getChildren()) {
            if (viewElement.hasClass('ck-widget')) {
              editor.editing.view.change(writer => {
                writer.setStyle('display', 'inline-block', viewElement);
                writer.setStyle('width', 'auto', viewElement);
              });
            }
          }
        });

        editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
          return {
            upload: () => {
              return new Promise((resolve, reject) => {
                const data = new FormData();
                loader.file.then(file => {
                  data.append('upload', file);
                  fetch("{{ url_for('post.upload_image') }}", {
                    method: 'POST',
                    body: data
                  })
                  .then(response => response.json())
                  .then(result => {
                    if (result.url) {
                      resolve({ default: result.url });
                    } else {
                      reject(result.error?.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
                    }
                  })
                  .catch(() => reject('ì„œë²„ì™€ í†µì‹  ì˜¤ë¥˜'));
                });
              });
            }
          };
        };

        document.querySelector('form').addEventListener('submit', (e) => {
          const content = editorInstance.getData().trim();
          if (!content) {
            alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            e.preventDefault();
            return;
          }
          document.querySelector('#editor').value = content;
        });
      })
      .catch(error => console.error("ğŸ›‘ CKEditor ì´ˆê¸°í™” ì‹¤íŒ¨:", error));
  </script>
{% endblock %}